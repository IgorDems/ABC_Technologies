---
- hosts: localhost
  become: yes
  tasks:
    - name: Docker login with token
      community.general.docker_login:
        registry_url: "https://index.docker.io/v1/"
        username: "{{ ansible_env.DOCKER_USERNAME }}"
        password: "{{ lookup('env', 'DOCKER_PASSWORD') }}"
        password_stdin: false

    - name: Build an image and push it to a private repo
      community.docker.docker_image:
        build:
          path: "/var/jenkins-agent/workspace/ABC_AnsibleK8s"
          name: docker.io/demsdocker/abctechnologies
          push: true
          source: build
      register: out
    - debug:
        var: out

    - name: Start a container
      community.docker.docker_container:
        name: abc-application
        image: demsdocker/abctechnologies
        state: started
        ports:
          - "1234:8080"
      register: out
    - debug:
        var: out

    - name: Create a Deployment by reading the definition from a local file
      command: "kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f /var/jenkins-agent/workspace/ABC_AnsibleK8s/deployment.yml"
      register: out
    - debug:
        var: out
